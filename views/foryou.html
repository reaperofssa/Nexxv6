<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>For You</title>
  <link rel="stylesheet" href="/css/foryou.css">
  <style>
    .verified-mark {
      width: 16px;
      height: 16px;
      margin-left: 3px;
      vertical-align: middle;
    }
    .media-container {
      position: relative;
    }
    .media {
      max-width: 100%;
      max-height: 80vh;
      display: block;
      margin: 0 auto;
    }
    .overlay {
      padding: 10px;
    }
    .caption {
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="posts-container"></div>

  <footer>
    <nav class="footer-nav">
      <button onclick="navigateTo('/foryou')">Home</button>
      <button onclick="navigateTo('/post')">Post</button>
      <button onclick="navigateTo('/me')">Me</button>
    </nav>
  </footer>

  <script>
    let currentIndex = 0;
let posts = [];
let isTransitioning = false;
let verifiedUsers = [];
let currentUser = null; // To store the logged-in user's details

// Function to fetch the current user (fetches from /api/me)
async function fetchCurrentUser() {
    const username = localStorage.getItem('username');
    
    if (!username) {
        console.error('No user logged in');
        return;
    }

    try {
        const res = await fetch('/api/me', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'x-username': username  // Send the username in the headers
            }
        });

        const data = await res.json();

        if (data.success) {
            currentUser = data.user; // Store current user details
        } else {
            console.error('Failed to fetch current user:', data.message);
        }
    } catch (error) {
        console.error('Error fetching current user:', error);
    }
}

// Function to fetch all posts
async function fetchPosts() {
    try {
        const res = await fetch('/api/posts');
        posts = await res.json();

        const verifiedRes = await fetch('/verified.json');
        const verifiedData = await verifiedRes.json();
        verifiedUsers = verifiedData.verifiedUsers || [];

        renderPost(currentIndex);
    } catch (error) {
        console.error('Error fetching posts or verified users:', error);
    }
}

// Function to render a post
function renderPost(index) {
    if (index < 0 || index >= posts.length) return;

    const postsContainer = document.getElementById('posts-container');
    postsContainer.innerHTML = '';

    const post = posts[index];
    const isVerified = verifiedUsers.includes(post.username);

    const postElement = document.createElement('div');
    postElement.className = 'post';

    const mediaContent = post.file
        ? post.file.endsWith('.mp4')
            ? `<video src="${post.file}" controls class="media"></video>`
            : `<img src="${post.file}" alt="Post Media" class="media" onerror="this.src='/images/placeholder.png'">`
        : `<img src="/images/placeholder.png" alt="Placeholder" class="media">`;

    postElement.innerHTML = `
        <div class="media-container">
          ${mediaContent}
        </div>
        <div class="overlay">
          <h3 class="username" onclick="navigateTo('/user/${post.username}')">
            ${post.username}
            ${isVerified ? `<img src="/images/verified-placeholder.png" alt="Verified" class="verified-mark" onerror="this.src='/images/verified-placeholder.png'">` : ''}
          </h3>
          <p class="caption">${post.caption}</p>
          <button class="like-button" onclick="likePost(${index})">
            ${post.liked ? '‚ù§Ô∏è Liked' : 'ü§ç Like'}
          </button>
          <button class="follow-button" onclick="followUser('${post.username}', ${index})">
                ${post.following ? 'Following' : 'Follow'}
          </button>
          <span class="like-count">${post.likes || 0} likes</span>
          <button class="share-button" onclick="sharePost('${post.id}')">üîó Share</button>
        </div>
    `;

    postsContainer.appendChild(postElement);
}

// Function to like a post
async function likePost(index) {
    const post = posts[index];
    const username = currentUser ? currentUser.username : null;

    if (!username) {
        alert('You need to log in to like posts.');
        return;
    }

    const updatedLiked = !post.liked;

    try {
        const response = await fetch('/api/like', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ postId: post.id, username, liked: updatedLiked }),
        });

        const data = await response.json();

        if (data.success) {
            // Update the post locally with server response
            post.liked = updatedLiked;
            post.likes = data.likes;
            renderPost(index);
        } else {
            console.error('Error updating like:', data.message);
        }
    } catch (error) {
        console.error('Error updating like:', error);
    }
}

// Function to follow a user
async function followUser(username) {
    try {
        const res = await fetch('/api/follow', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username }),
        });

        if (res.ok) {
            const result = await res.json();
            alert(result.message || 'Follow status updated!');
            posts[currentIndex].following = !posts[currentIndex].following;
            renderPost(currentIndex);
        }
    } catch (error) {
        console.error('Error following user:', error);
    }
}

// Function to share a post
function sharePost(postId) {
    const uniqueLink = `${window.location.origin}/foryou?post=${postId}`;
    navigator.clipboard.writeText(uniqueLink).then(() => {
        alert('Post link copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy link:', err);
    });
}

// Function to navigate between posts
function navigatePost(direction) {
    if (isTransitioning) return;
    isTransitioning = true;

    const newIndex = currentIndex + direction;
    if (newIndex >= 0 && newIndex < posts.length) {
        currentIndex = newIndex;
        renderPost(currentIndex);
    }

    setTimeout(() => {
        isTransitioning = false;
    }, 300);
}

// Event listeners for touch navigation
let startY = 0;
window.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
});

window.addEventListener('touchend', (e) => {
    const endY = e.changedTouches[0].clientY;
    const distance = startY - endY;

    if (distance > 50) navigatePost(1);
    else if (distance < -50) navigatePost(-1);
});

// Function to navigate to a new route
function navigateTo(route) {
    window.location.href = route;
}

// Fetch user and posts when the app loads
async function initializeApp() {
    await fetchCurrentUser();  // Fetch the current user
    await fetchPosts();        // Fetch all posts
}

initializeApp();
  </script>
</body>
</html>
