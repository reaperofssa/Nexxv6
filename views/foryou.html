<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>For You</title>
  <style>
    .verified-mark {
      width: 16px;
      height: 16px;
      margin-left: 3px;
      vertical-align: middle;
    }
    .media-container {
      position: relative;
    }
    .media {
      max-width: 100%;
      max-height: 80vh;
      display: block;
      margin: 0 auto;
    }
    .overlay {
      padding: 10px;
    }
    .caption {
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="posts-container"></div>

  <footer>
    <nav class="footer-nav">
      <button onclick="navigateTo('/foryou')">Home</button>
      <button onclick="navigateTo('/post')">Post</button>
      <button onclick="navigateTo('/me')">Me</button>
    </nav>
  </footer>

  <script>
    let currentIndex = 0;
    let posts = [];
    const currentUser = 'REIKER'; // Simulating the logged-in user

    async function fetchPosts() {
      try {
        const res = await fetch('/api/posts');
        posts = await res.json();
        renderPost(currentIndex);
      } catch (error) {
        console.error('Error fetching posts:', error);
      }
    }

    function renderPost(index) {
      if (index < 0 || index >= posts.length) return;

      const postsContainer = document.getElementById('posts-container');
      postsContainer.innerHTML = '';

      const post = posts[index];
      const isLiked = post.likedBy?.includes(currentUser);

      const postElement = document.createElement('div');
      postElement.className = 'post';

      const mediaContent = post.file
        ? post.file.endsWith('.mp4')
          ? `<video src="${post.file}" controls class="media"></video>`
          : `<img src="${post.file}" alt="Post Media" class="media" onerror="this.src='/images/placeholder.png'">`
        : `<img src="/images/placeholder.png" alt="Placeholder" class="media">`;

      postElement.innerHTML = `
        <div class="media-container">
          ${mediaContent}
        </div>
        <div class="overlay">
          <h3 class="username">
            ${post.username}
          </h3>
          <p class="caption">${post.caption}</p>
          <button class="like-button" onclick="likePost(${index})">
            ${isLiked ? '‚ù§Ô∏è Liked' : 'ü§ç Like'}
          </button>
          <span class="like-count">${post.likedBy?.length || 0} likes</span>
          <button class="share-button" onclick="sharePost('${post.id}')">üîó Share</button>
        </div>
      `;

      postsContainer.appendChild(postElement);
    }

    async function likePost(index) {
      const post = posts[index];
      const likedBy = post.likedBy || [];

      if (likedBy.includes(currentUser)) {
        post.likedBy = likedBy.filter((user) => user !== currentUser); // Unlike
      } else {
        post.likedBy.push(currentUser); // Like
      }

      try {
        await fetch('/api/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postId: post.id, likedBy: post.likedBy }),
        });
        renderPost(index);
      } catch (error) {
        console.error('Error updating like:', error);
      }
    }

    function sharePost(postId) {
      const uniqueLink = `${window.location.origin}/foryou?post=${postId}`;
      navigator.clipboard.writeText(uniqueLink).then(() => {
        alert('Post link copied to clipboard!');
      }).catch((err) => {
        console.error('Failed to copy link:', err);
      });
    }

    function navigateTo(route) {
      window.location.href = route;
    }

    fetchPosts();
  </script>
</body>
</html>
