<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>For You</title>
  <link rel="stylesheet" href="/css/foryou.css">
  <style>
    .verified-mark {
      width: 16px;
      height: 16px;
      margin-left: 3px;
      vertical-align: middle;
    }
    .media-container {
      position: relative;
    }
    .media {
      max-width: 100%;
      max-height: 80vh;
      display: block;
      margin: 0 auto;
    }
    .overlay {
      padding: 10px;
    }
    .caption {
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="posts-container"></div>

  <footer>
    <nav class="footer-nav">
      <button onclick="navigateTo('/foryou')">Home</button>
      <button onclick="navigateTo('/post')">Post</button>
      <button onclick="navigateTo('/me')">Me</button>
    </nav>
  </footer>

  <script>
    let currentIndex = 0;
    let posts = [];
    let isTransitioning = false;
    let verifiedUsers = [];

    async function fetchPosts() {
      try {
        const res = await fetch('/api/posts');
        posts = await res.json();

        const verifiedRes = await fetch('/verified.json');
        const verifiedData = await verifiedRes.json();
        verifiedUsers = verifiedData.verifiedUsers || [];

        renderPost(currentIndex);
      } catch (error) {
        console.error('Error fetching posts or verified users:', error);
      }
    }

    function renderPost(index) {
      if (index < 0 || index >= posts.length) return;

      const postsContainer = document.getElementById('posts-container');
      postsContainer.innerHTML = '';

      const post = posts[index];
      const loggedInUsername = localStorage.getItem('username'); // Current user's username
      const isVerified = verifiedUsers.includes(post.username);
      const userLiked = post.userLikes?.[loggedInUsername] || false;

      const postElement = document.createElement('div');
      postElement.className = 'post';

      const mediaContent = post.file
        ? post.file.endsWith('.mp4')
          ? `<video src="${post.file}" controls class="media"></video>`
          : `<img src="${post.file}" alt="Post Media" class="media" onerror="this.src='/images/placeholder.png'">`
        : `<img src="/images/placeholder.png" alt="Placeholder" class="media">`;

      postElement.innerHTML = `
        <div class="media-container">
          ${mediaContent}
        </div>
        <div class="overlay">
          <h3 class="username" onclick="navigateTo('/user/${post.username}')">
            ${post.username}
            ${isVerified ? `<img src="https://im.ge/i/IMG-9380.zZaAyK" alt="Verified" class="verified-mark" onerror="this.src='/images/verified-placeholder.png'">` : ''}
          </h3>
          <p class="caption">${post.caption}</p>
          <button class="like-button" onclick="likePost(${index})">
            ${userLiked ? '‚ù§Ô∏è Liked' : 'ü§ç Like'}
          </button>
          <span class="like-count">${post.likes || 0} likes</span>
        </div>
      `;

      postsContainer.appendChild(postElement);
    }

    async function likePost(index) {
      const post = posts[index];
      const loggedInUsername = localStorage.getItem('username'); // Current user's username

      // Construct the API URL
      const apiUrl = `/api/like`;

      // Toggle like status for the logged-in user
      const userLiked = post.userLikes?.[loggedInUsername] || false;
      post.userLikes[loggedInUsername] = !userLiked;
      post.likes = Object.values(post.userLikes).filter(Boolean).length;

      try {
        // Send like request
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            postId: post.id,
            liked: post.userLikes[loggedInUsername],
            username: loggedInUsername, // Include the username in the payload
          }),
        });

        if (res.ok) {
          renderPost(index);
        } else {
          console.error('Failed to update likes:', await res.text());
          // Revert changes if API call fails
          post.userLikes[loggedInUsername] = userLiked;
          post.likes = Object.values(post.userLikes).filter(Boolean).length;
        }
      } catch (error) {
        console.error('Error updating like:', error);
        // Revert changes on error
        post.userLikes[loggedInUsername] = userLiked;
        post.likes = Object.values(post.userLikes).filter(Boolean).length;
      }
    }

    function navigateTo(route) {
      window.location.href = route;
    }

    fetchPosts();
  </script>
</body>
</html>
