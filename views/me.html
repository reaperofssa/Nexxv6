<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="/css/me.css">
</head>
<body>
    <div class="profile-container">
        <div class="profile-info">
            <img id="profilePicture" src="/default-profile.png" alt="Profile Picture">
            <div class="profile-text">
                <h1 id="username">@username</h1>
                <div class="follow-info">
                    <p id="followers">0 Followers</p>
                    <p id="following">0 Following</p>
                </div>
            </div>
        </div>
    </div>
    <div class="posts-container" id="myPosts"></div>
    <footer>
        <nav class="footer-nav">
            <button onclick="navigateTo('/foryou')">For You</button>
            <button onclick="navigateTo('/post')">Post</button>
            <button onclick="navigateTo('/me')">Me</button>
        </nav>
    </footer>

    <script>
        function navigateTo(route) {
            window.location.href = route;
        }

        async function loadProfile() {
            const username = localStorage.getItem('username'); // Fetch username from local storage

            if (!username) {
                alert('No user is logged in.');
                return;
            }

            try {
                // Fetch profile data
                const res = await fetch('/api/me', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-username': username, // Send username in header
                    },
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    const { user, posts } = data;

                    // Update profile details
                    const usernameElement = document.getElementById('username');
                    usernameElement.textContent = `@${user.username}`;

                    document.getElementById('followers').textContent = `${user.followers} Followers`;
                    document.getElementById('following').textContent = `${user.following.length} Following`;
                    document.getElementById('profilePicture').src = user.profilePicture || '/images/default-profile.png';

                    // Display user posts
                    document.getElementById('myPosts').innerHTML = posts.map(post => `
                        <div class="post">
                            <div class="media-container" onclick="openPost('${post.id}')">
                                ${post.file.endsWith('.mp4') 
                                    ? `<video src="${post.file}" controls class="media"></video>` 
                                    : `<img src="${post.file}" alt="Post Image" class="media">`}
                            </div>
                            <p>${post.caption}</p>
                            <div class="post-stats">
                                <span>❤️ ${post.likes}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('An error occurred while loading the profile.');
            }
        }

        function openPost(postId) {
            const postUrl = `/foryou?post=${postId}`;
            window.location.href = postUrl;
        }

        // Load profile on page load
        loadProfile();
    </script>
</body>
</html>
